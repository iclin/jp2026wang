<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Trip 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            base: '#F0EBE5',
                            blue: '#8CA6A8',
                            pink: '#D9C6C3',
                            green: '#Aeb7a3',
                            dark: '#5E6166',
                            card: '#FFFFFF',
                            accent: '#E6Bfac'
                        }
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F0EBE5;
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { scroll-behavior: smooth; }
        .pixar-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .ghost-card { opacity: 0.5; background: #E6Bfac; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-morandi-dark antialiased pb-20">

    <div id="app" v-cloak>
        <!-- 頁首 Banner -->
        <header class="relative h-[250px] w-full overflow-hidden group">
            <div class="absolute inset-0 bg-morandi-blue">
                <img :src="headerImage" class="w-full h-full object-cover object-center" alt="Header Banner" onerror="this.style.display='none'">
            </div>
            
            <div class="absolute inset-0 bg-gradient-to-l from-black/40 via-transparent to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>

            <div class="absolute top-10 right-4 text-right z-20">
                <h1 class="text-3xl font-bold text-white drop-shadow-md leading-tight font-sans tracking-tight">Japan 2026</h1>
                <div class="text-lg font-bold text-white/90 drop-shadow-md tracking-wider mt-1">名古屋/東京之旅</div>
            </div>

            <div class="absolute bottom-6 right-6 flex gap-3 z-20 items-end">
                <button v-for="tab in tabs" :key="tab.id" 
                    @click="currentTab = tab.id"
                    :class="['w-11 h-11 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 transform border-2 backdrop-blur-sm', 
                             currentTab === tab.id ? 'bg-morandi-accent text-white border-white scale-110 shadow-morandi-accent/50' : 'bg-white/80 text-morandi-blue border-white/50 hover:bg-white']">
                    <i :class="tab.icon + ' text-lg'"></i>
                </button>
            </div>
        </header>

        <!-- 主內容區域 -->
        <main class="relative z-10 -mt-8 bg-morandi-base rounded-t-[2.5rem] min-h-screen px-4 pt-8 pb-24 overflow-hidden shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
            
            <div class="flex justify-center mb-2">
                <div class="w-12 h-1.5 bg-morandi-dark/20 rounded-full"></div>
            </div>

            <!-- ================= TAB 1: 每日行程表 ================= -->
            <section v-if="currentTab === 'itinerary'" class="animate-fade-in">
                
                <div class="flex overflow-x-auto hide-scrollbar space-x-3 mb-6 py-2 px-1">
                    <div v-for="(day, index) in itineraryDays" :key="index" 
                         @click="selectedDayIndex = index"
                         :class="['flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 cursor-pointer border-2',
                                  selectedDayIndex === index ? 'bg-morandi-blue text-white border-morandi-blue shadow-lg transform scale-105' : 'bg-white text-morandi-dark border-transparent shadow-sm']">
                        <span class="text-sm font-bold uppercase tracking-wide">{{ day.weekday }}</span>
                        <span class="text-2xl font-bold font-sans">{{ day.dateNumber }}</span>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-100 to-white p-4 rounded-3xl shadow-sm mb-6 flex items-center justify-between border border-white">
                    <div class="flex items-center space-x-4">
                        <i :class="currentWeather.icon + ' text-4xl text-yellow-500 drop-shadow-sm'"></i>
                        <div>
                            <div class="text-3xl font-bold text-morandi-blue">{{ currentWeather.temp }}°C</div>
                            <div class="text-xs text-morandi-dark/70">體感 {{ currentWeather.feelsLike }}°C</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold">{{ selectedDayData.location }}</div>
                        <div class="text-xs text-gray-500">{{ currentWeather.desc }}</div>
                    </div>
                </div>

                <div class="space-y-0 relative">
                    <div class="absolute left-6 top-4 bottom-4 w-0.5 border-l-2 border-dashed border-morandi-dark/20 z-0"></div>

                    <div v-if="loading" class="text-center py-10 text-gray-400 z-10 relative">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>載入中...</p>
                    </div>

                    <div v-else v-for="(item, idx) in selectedDayData.items" :key="item.id" 
                         class="relative pl-0 mb-6 group"
                         draggable="true"
                         @dragstart="dragStart(idx)"
                         @dragover.prevent
                         @drop="drop(idx)">
                        
                        <div v-if="idx > 0 || (idx === 0 && selectedDayIndex > 0)" class="flex items-center pl-12 mb-2 space-x-2 text-xs text-morandi-dark/60 font-medium">
                            <span class="bg-morandi-base px-2 py-0.5 rounded-full z-10 flex items-center gap-1 border border-morandi-dark/10">
                                <i :class="getTransportIcon(item.transportType)"></i>
                                {{ item.transportTime || '計算中...' }}
                            </span>
                        </div>
                        <div v-else-if="idx === 0 && selectedDayIndex === 0" class="h-2"></div>

                        <div class="relative z-10 flex items-start">
                            <div class="absolute left-[1.35rem] top-8 w-3 h-3 bg-morandi-accent rounded-full border-2 border-white ring-2 ring-morandi-accent/30"></div>

                            <div @click="openMap(item.name)" 
                                 class="ml-10 flex-1 bg-white rounded-2xl p-4 shadow-sm border border-white hover:shadow-md transition-shadow active:scale-[0.98] cursor-pointer relative overflow-hidden">
                                
                                <div :class="['absolute top-0 left-0 w-1.5 h-full', getCategoryColor(item.category)]"></div>
                                
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs font-bold px-2 py-0.5 rounded-md bg-gray-100 text-gray-500">{{ item.category }}</span>
                                            <!-- 航班特殊顯示標題 -->
                                            <h3 v-if="item.category === '航班'" class="font-bold text-lg text-morandi-dark leading-tight">{{ item.flightStart }} <i class="fa-solid fa-arrow-right text-xs mx-1 opacity-50"></i> {{ item.flightEnd }}</h3>
                                            <h3 v-else class="font-bold text-lg text-morandi-dark leading-tight">{{ item.name }}</h3>
                                        </div>
                                        
                                        <div class="text-sm text-gray-500 space-y-1 mt-2">
                                            <div v-if="item.time" class="flex items-center gap-2">
                                                <i class="fa-regular fa-clock w-4 text-center"></i> {{ item.time }}
                                            </div>
                                            <div v-if="item.ticket" class="flex items-center gap-2">
                                                <i class="fa-solid fa-ticket w-4 text-center"></i> {{ item.ticket }}
                                            </div>
                                            <div v-if="item.note" class="flex items-center gap-2">
                                                <i class="fa-regular fa-sticky-note w-4 text-center"></i> {{ item.note }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button @click.stop="editItem(item, idx)" class="text-gray-300 hover:text-morandi-blue p-2">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                </div>
                                
                                <div v-if="item.category === '航班'" class="mt-3 pt-3 border-t border-dashed border-gray-200">
                                    <div class="flex justify-between items-center text-morandi-blue">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold font-sans">{{ item.flightStart }}</div>
                                            <div class="text-xs">{{ item.flightStartTime }}</div>
                                        </div>
                                        <div class="flex flex-col items-center px-4 opacity-50">
                                            <i class="fa-solid fa-plane text-xl"></i>
                                            <div class="text-[10px] mt-1">{{ item.flightDuration || '飛行中' }}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold font-sans">{{ item.flightEnd }}</div>
                                            <div class="text-xs">{{ item.flightEndTime }}</div>
                                        </div>
                                    </div>
                                    <div class="text-center text-xs text-gray-400 mt-2 font-bold">{{ item.flightCode }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="openModal('add')" 
                    class="fixed bottom-24 right-6 w-14 h-14 bg-morandi-blue text-white rounded-full shadow-lg shadow-morandi-blue/40 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </section>

            <!-- ================= TAB 2: 資訊 ================= -->
            <section v-if="currentTab === 'info'" class="space-y-6 animate-fade-in">
                
                <div class="bg-white rounded-3xl p-6 shadow-sm pixar-shadow relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-yellow-100 rounded-full opacity-50"></div>
                    <h3 class="text-lg font-bold text-morandi-dark mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-calculator text-yellow-500"></i> 匯率試算
                    </h3>
                    <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <span class="text-gray-500 font-bold">JPY</span>
                        <input type="number" v-model="currencyInput" placeholder="輸入日幣" class="bg-transparent w-full outline-none text-xl font-bold text-morandi-dark">
                    </div>
                    <div class="flex justify-center my-2 text-gray-400"><i class="fa-solid fa-arrow-down"></i></div>
                    <div class="flex items-center justify-between px-3">
                        <span class="text-gray-500 font-bold">TWD</span>
                        <span class="text-2xl font-bold text-morandi-blue">{{ convertedCurrency }}</span>
                    </div>
                    <div class="text-xs text-right text-gray-400 mt-2">匯率: 0.22 (模擬)</div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm pixar-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-morandi-dark flex items-center gap-2">
                            <i class="fa-solid fa-plane-departure text-morandi-blue"></i> 航班資訊
                        </h3>
                        <div class="text-right bg-gray-50 px-3 py-1 rounded-lg border border-gray-100">
                            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">訂位代號</div>
                            <div class="text-lg font-bold text-morandi-dark leading-none select-all font-sans">CTFM9R</div>
                        </div>
                    </div>
                    
                    <div v-for="(flight, idx) in flights" :key="idx" class="mb-6 last:mb-0 border-b last:border-0 border-gray-100 pb-4 last:pb-0">
                        <div class="flex justify-between text-xs text-white bg-morandi-blue px-3 py-1 rounded-full w-max mb-2">
                            {{ flight.date }}
                        </div>
                        <div class="flex justify-between items-center px-2">
                            <div class="text-center">
                                <div class="text-3xl font-black text-morandi-dark tracking-tighter">{{ flight.depCode }}</div>
                                <div class="text-sm font-bold text-morandi-blue">{{ flight.depTime }}</div>
                            </div>
                            <div class="flex-1 px-4 flex flex-col items-center">
                                <div class="text-xs text-gray-400 mb-1">{{ flight.duration }}</div>
                                <div class="w-full h-0.5 bg-gray-300 relative">
                                    <i class="fa-solid fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-morandi-accent"></i>
                                </div>
                                <div class="text-xs text-gray-500 font-bold mt-1">{{ flight.number }}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-black text-morandi-dark tracking-tighter">{{ flight.arrCode }}</div>
                                <div class="text-sm font-bold text-morandi-blue">{{ flight.arrTime }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 shadow-sm pixar-shadow">
                    <h3 class="text-lg font-bold text-morandi-dark mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-bed text-morandi-pink"></i> 住宿資訊
                    </h3>
                    <div v-for="(hotel, idx) in hotels" :key="idx" class="mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="text-xs text-morandi-accent font-bold mb-1">{{ hotel.period }}</div>
                        <h4 class="font-bold text-morandi-dark mb-2">{{ hotel.name }}</h4>
                        <p class="text-xs text-gray-500 mb-3"><i class="fa-solid fa-location-dot mr-1"></i> {{ hotel.address }}</p>
                        <button @click="openMap(hotel.name)" class="w-full py-2 bg-white border border-morandi-blue text-morandi-blue rounded-lg text-sm font-bold hover:bg-morandi-blue hover:text-white transition-colors">
                            導航去飯店
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-red-50 p-4 rounded-2xl flex flex-col items-center justify-center text-red-400 border border-red-100">
                        <i class="fa-solid fa-kit-medical text-3xl mb-2"></i>
                        <span class="font-bold text-sm">救護車 119</span>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-2xl flex flex-col items-center justify-center text-blue-400 border border-blue-100">
                        <i class="fa-solid fa-user-shield text-3xl mb-2"></i>
                        <span class="font-bold text-sm">警察局 110</span>
                    </div>
                </div>
            </section>

            <!-- ================= TAB 3: 購物清單 ================= -->
            <section v-if="currentTab === 'shopping'" class="animate-fade-in">
                <h3 class="text-xl font-bold text-morandi-dark mb-4 px-2">Wish List</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-3 shadow-sm pixar-shadow relative group">
                        <button @click="removeShoppingItem(idx)" class="absolute top-2 right-2 w-6 h-6 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        
                        <div class="aspect-square rounded-xl bg-gray-100 mb-3 overflow-hidden">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                <i class="fa-solid fa-image text-2xl"></i>
                            </div>
                        </div>
                        <div class="font-bold text-morandi-dark truncate">{{ item.name }}</div>
                    </div>
                </div>

                <button @click="showShoppingModal = true" 
                    class="fixed bottom-24 right-6 w-14 h-14 bg-morandi-pink text-white rounded-full shadow-lg shadow-morandi-pink/40 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </section>

            <!-- ================= TAB 4: 花費 ================= -->
            <section v-if="currentTab === 'expenses'" class="animate-fade-in">
                <div class="bg-morandi-green rounded-3xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white opacity-20 rounded-full"></div>
                    <div class="text-sm opacity-80 mb-1">總支出 (JPY)</div>
                    <div class="text-4xl font-bold font-sans">¥ {{ totalExpenses.toLocaleString() }}</div>
                    <div class="mt-4 flex gap-2">
                         <span class="text-xs bg-white/20 px-2 py-1 rounded">現金: {{ expensesByMethod('現金') }}</span>
                         <span class="text-xs bg-white/20 px-2 py-1 rounded">卡片: {{ expensesByMethod('信用卡') }}</span>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-4 shadow-sm min-h-[300px]">
                    <div v-if="expenses.length === 0" class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-coins text-4xl mb-3 opacity-30"></i>
                        <p>還沒有花費紀錄</p>
                    </div>
                    <div v-else v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-morandi-blue">
                                <i :class="getExpenseIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-morandi-dark">{{ exp.name }}</div>
                                <div class="text-xs text-gray-400">{{ exp.date }} · {{ exp.payment }}</div>
                            </div>
                        </div>
                        <div class="font-bold font-sans text-morandi-dark">¥ {{ parseInt(exp.amount).toLocaleString() }}</div>
                    </div>
                </div>

                <button @click="openExpenseModal" 
                    class="fixed bottom-24 right-6 w-14 h-14 bg-morandi-green text-white rounded-full shadow-lg shadow-morandi-green/40 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-50">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </section>

        </main>

        <!-- ================= MODALS ================= -->

        <!-- 行程 Modal -->
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative animate-slide-up">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    <div v-if="modalForm.category === '航班'" class="text-xs bg-blue-100 text-blue-500 px-2 py-1 rounded-lg font-bold">
                        <i class="fa-solid fa-plane"></i> 航班模式
                    </div>
                </div>
                
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                    <!-- 分類 (共用) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">分類</label>
                        <select v-model="modalForm.category" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 transition-colors focus:border-morandi-blue">
                            <option>景點</option>
                            <option>住宿</option>
                            <option>美食</option>
                            <option>購物</option>
                            <option>航班</option>
                            <option>其他</option>
                        </select>
                    </div>

                    <!-- ===== 航班專屬介面 ===== -->
                    <div v-if="modalForm.category === '航班'" class="space-y-4 animate-fade-in">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">出發機場 (代號)</label>
                                <input type="text" v-model="modalForm.flightStart" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 uppercase font-sans font-bold text-center" placeholder="TPE">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">起飛時間</label>
                                <input type="time" v-model="modalForm.flightStartTime" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 text-center">
                            </div>
                        </div>
                        
                        <div class="flex justify-center text-morandi-blue opacity-50">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">抵達機場 (代號)</label>
                                <input type="text" v-model="modalForm.flightEnd" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 uppercase font-sans font-bold text-center" placeholder="KIX">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">抵達時間</label>
                                <input type="time" v-model="modalForm.flightEndTime" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 text-center">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">航班代號</label>
                            <input type="text" v-model="modalForm.flightCode" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 uppercase" placeholder="例如: GK50">
                        </div>
                    </div>

                    <!-- ===== 一般行程介面 (非航班) ===== -->
                    <div v-else class="space-y-4 animate-fade-in">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">名稱</label>
                            <input type="text" v-model="modalForm.name" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200" placeholder="輸入地點名稱">
                        </div>
                        <div v-if="['景點','住宿','美食','購物'].includes(modalForm.category)">
                            <label class="block text-xs font-bold text-gray-500 mb-1">營業時間</label>
                            <input type="text" v-model="modalForm.time" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200" placeholder="09:00 - 20:00">
                        </div>
                        <div v-if="modalForm.category === '景點'">
                            <label class="block text-xs font-bold text-gray-500 mb-1">門票資訊</label>
                            <input type="text" v-model="modalForm.ticket" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200" placeholder="¥2000 / 無">
                        </div>
                    </div>

                    <!-- 備註 (共用) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">特色 & 備註</label>
                        <textarea v-model="modalForm.note" class="w-full bg-gray-50 rounded-xl p-3 outline-none border border-gray-200 h-20"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="deleteItemConfirm" class="flex-1 py-3 bg-red-100 text-red-500 rounded-xl font-bold hover:bg-red-200 transition-colors">刪除</button>
                    <button @click="showModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-gray-200 transition-colors">取消</button>
                    <button @click="saveItem" class="flex-[2] py-3 bg-morandi-blue text-white rounded-xl font-bold shadow-lg shadow-morandi-blue/30 hover:scale-[1.02] transition-transform">確認</button>
                </div>
            </div>
        </div>

        <!-- 購物 Modal -->
        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">新增購物清單</h3>
                <input type="text" v-model="shoppingForm.name" placeholder="商品名稱" class="w-full bg-gray-50 rounded-xl p-3 mb-4 outline-none border border-gray-200">
                
                <div class="relative w-full h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer overflow-hidden mb-4">
                    <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                    <img v-if="shoppingForm.image" :src="shoppingForm.image" class="w-full h-full object-cover">
                    <div v-else class="text-center">
                        <i class="fa-solid fa-camera mb-1"></i>
                        <span class="text-xs block">上傳圖片</span>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button @click="showShoppingModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">取消</button>
                    <button @click="addShoppingItem" class="flex-1 py-3 bg-morandi-pink text-white rounded-xl font-bold">新增</button>
                </div>
            </div>
        </div>

        <!-- 花費 Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">記帳</h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <select v-model="expenseForm.category" class="bg-gray-50 rounded-xl p-3 outline-none border border-gray-200">
                        <option>飲食</option>
                        <option>交通</option>
                        <option>住宿</option>
                        <option>門票</option>
                        <option>購物</option>
                        <option>其他</option>
                    </select>
                    <select v-model="expenseForm.payment" class="bg-gray-50 rounded-xl p-3 outline-none border border-gray-200">
                        <option>現金</option>
                        <option>信用卡</option>
                    </select>
                </div>
                <input type="date" v-model="expenseForm.date" class="w-full bg-gray-50 rounded-xl p-3 mb-3 outline-none border border-gray-200">
                <input type="text" v-model="expenseForm.name" placeholder="項目名稱" class="w-full bg-gray-50 rounded-xl p-3 mb-3 outline-none border border-gray-200">
                <input type="number" v-model="expenseForm.amount" placeholder="金額 (JPY)" class="w-full bg-gray-50 rounded-xl p-3 mb-3 outline-none border border-gray-200 text-lg font-bold">
                
                <div class="flex gap-3">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">取消</button>
                    <button @click="saveExpense" class="flex-1 py-3 bg-morandi-green text-white rounded-xl font-bold">儲存</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, reactive, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        // 您的 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyBfWSyiXaYRJdvzjs0XohTJsjWSUSfUCXI",
            authDomain: "nagoya-815b1.firebaseapp.com",
            projectId: "nagoya-815b1",
            storageBucket: "nagoya-815b1.firebasestorage.app",
            messagingSenderId: "810455743100",
            appId: "1:810455743100:web:d8dd1514b79daa82df67f9",
            measurementId: "G-RZQKCWJFGX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const TRIP_COLLECTION = 'trip_2026';

        createApp({
            setup() {
                const loading = ref(true);
                const currentTab = ref('itinerary');
                const headerImage = ref('wang1.jpg');
                
                const tabs = [
                    { id: 'itinerary', icon: 'fa-solid fa-map-location-dot' },
                    { id: 'info', icon: 'fa-solid fa-circle-info' },
                    { id: 'shopping', icon: 'fa-solid fa-basket-shopping' },
                    { id: 'expenses', icon: 'fa-solid fa-yen-sign' }
                ];

                // 初始資料結構
                const initialDays = [
                    { date: '2026-01-25', dateNumber: '25', weekday: 'Sun', location: '大阪', items: [] },
                    { date: '2026-01-26', dateNumber: '26', weekday: 'Mon', location: '名古屋', items: [] },
                    { date: '2026-01-27', dateNumber: '27', weekday: 'Tue', location: '名古屋', items: [] },
                    { date: '2026-01-28', dateNumber: '28', weekday: 'Wed', location: '名古屋', items: [] },
                    { date: '2026-01-29', dateNumber: '29', weekday: 'Thu', location: '東京', items: [] },
                    { date: '2026-01-30', dateNumber: '30', weekday: 'Fri', location: '東京', items: [] },
                    { date: '2026-01-31', dateNumber: '31', weekday: 'Sat', location: '東京', items: [] },
                    { date: '2026-02-01', dateNumber: '01', weekday: 'Sun', location: '東京', items: [] },
                ];
                
                const day0DefaultItems = [
                    { id: 101, category: '航班', flightStart:'TPE', flightStartTime:'02:30', flightEnd:'KIX', flightEndTime:'06:00', flightCode:'GK50', note: '抵達關西機場' },
                    { id: 102, category: '航班', flightStart:'KIX', flightStartTime:'08:00', flightEnd:'NRT', flightEndTime:'09:25', flightCode:'GK230', note: '轉機前往東京', transportType: 'train', transportTime: '2h 轉機' },
                    { id: 103, category: '美食', name: '名古屋知名鰻魚飯', time: '12:00', transportType: 'train', transportTime: '1h 30m' },
                    { id: 104, category: '景點', name: '名古屋城', time: '14:00', ticket:'¥500', transportType: 'car', transportTime: '15m' },
                    { id: 105, category: '住宿', name: 'Daiwa Roynet Hotel Nagoya', time: '18:00', transportType: 'walk', transportTime: '10m' }
                ];

                const itineraryDays = ref(JSON.parse(JSON.stringify(initialDays)));
                const selectedDayIndex = ref(0);
                const selectedDayData = computed(() => itineraryDays.value[selectedDayIndex.value]);

                const weatherData = {
                    'Sun': { temp: 8, icon: 'fa-solid fa-sun', desc: '晴朗', feelsLike: 5 },
                    'Mon': { temp: 6, icon: 'fa-solid fa-cloud', desc: '多雲', feelsLike: 4 },
                    'Tue': { temp: 4, icon: 'fa-solid fa-cloud-rain', desc: '小雨', feelsLike: 1 },
                    'Wed': { temp: 5, icon: 'fa-regular fa-snowflake', desc: '微雪', feelsLike: 0 },
                    'Thu': { temp: 9, icon: 'fa-solid fa-sun', desc: '晴時多雲', feelsLike: 7 },
                    'Fri': { temp: 10, icon: 'fa-solid fa-sun', desc: '晴朗', feelsLike: 9 },
                    'Sat': { temp: 8, icon: 'fa-solid fa-cloud', desc: '陰天', feelsLike: 6 }
                };
                const currentWeather = computed(() => weatherData[selectedDayData.value.weekday] || weatherData['Sun']);

                onMounted(() => {
                    initialDays.forEach((dayStruct, index) => {
                        onSnapshot(doc(db, TRIP_COLLECTION, `day_${index}`), (docSnap) => {
                            if (docSnap.exists()) {
                                itineraryDays.value[index] = docSnap.data();
                            } else {
                                const dataToSave = { ...dayStruct };
                                if(index === 0) dataToSave.items = day0DefaultItems;
                                setDoc(doc(db, TRIP_COLLECTION, `day_${index}`), dataToSave);
                            }
                        });
                    });

                    onSnapshot(doc(db, TRIP_COLLECTION, 'shopping'), (docSnap) => {
                        if (docSnap.exists()) shoppingList.value = docSnap.data().items || [];
                        else setDoc(doc(db, TRIP_COLLECTION, 'shopping'), { items: [] });
                    });

                    onSnapshot(doc(db, TRIP_COLLECTION, 'expenses'), (docSnap) => {
                        if (docSnap.exists()) expenses.value = docSnap.data().items || [];
                        else setDoc(doc(db, TRIP_COLLECTION, 'expenses'), { items: [] });
                        loading.value = false;
                    });
                });

                const updateDayDoc = (index) => {
                    setDoc(doc(db, TRIP_COLLECTION, `day_${index}`), itineraryDays.value[index]);
                };

                // === Modal Logic ===
                const showModal = ref(false);
                const isEditing = ref(false);
                const editingIndex = ref(-1);
                // 初始化 Modal 表單，包含所有可能的欄位
                const modalForm = reactive({ 
                    category: '景點', name: '', time: '', ticket: '', note: '',
                    flightStart: '', flightStartTime: '', flightEnd: '', flightEndTime: '', flightCode: ''
                });

                const openModal = (mode, item = null, index = -1) => {
                    isEditing.value = mode === 'edit';
                    if (isEditing.value && item) {
                        Object.assign(modalForm, item);
                        editingIndex.value = index;
                    } else {
                        // 重置表單，避免殘留資料
                        Object.assign(modalForm, { 
                            category: '景點', name: '', time: '', ticket: '', note: '',
                            flightStart: '', flightStartTime: '', flightEnd: '', flightEndTime: '', flightCode: ''
                        });
                    }
                    showModal.value = true;
                };

                const editItem = (item, idx) => openModal('edit', item, idx);

                const saveItem = () => {
                    // 自動為航班建立 name (雖然主要顯示用專屬欄位，但保持 name 有值是好習慣)
                    if (modalForm.category === '航班' && !modalForm.name) {
                        modalForm.name = `${modalForm.flightStart} - ${modalForm.flightEnd}`;
                    }

                    const newItem = { 
                        ...modalForm, 
                        id: isEditing.value ? itineraryDays.value[selectedDayIndex.value].items[editingIndex.value].id : Date.now(),
                        transportType: ['walk','car','train'][Math.floor(Math.random()*3)],
                        transportTime: Math.floor(Math.random()*30 + 5) + ' min'
                    };
                    
                    if (isEditing.value) {
                        itineraryDays.value[selectedDayIndex.value].items[editingIndex.value] = newItem;
                    } else {
                        itineraryDays.value[selectedDayIndex.value].items.push(newItem);
                    }
                    updateDayDoc(selectedDayIndex.value);
                    showModal.value = false;
                };

                const deleteItemConfirm = () => {
                    if(confirm("確定要刪除這個行程嗎？")) {
                        itineraryDays.value[selectedDayIndex.value].items.splice(editingIndex.value, 1);
                        updateDayDoc(selectedDayIndex.value);
                        showModal.value = false;
                    }
                };

                // Drag & Drop
                let draggedItemIndex = null;
                const dragStart = (index) => { draggedItemIndex = index; };
                const drop = (dropIndex) => {
                    const items = itineraryDays.value[selectedDayIndex.value].items;
                    const itemToMove = items.splice(draggedItemIndex, 1)[0];
                    items.splice(dropIndex, 0, itemToMove);
                    updateDayDoc(selectedDayIndex.value);
                };

                // Helpers
                const getCategoryColor = (cat) => {
                    const map = { '景點': 'bg-pink-400', '住宿': 'bg-indigo-400', '美食': 'bg-orange-400', '購物': 'bg-red-400', '航班': 'bg-blue-400', '其他': 'bg-gray-400' };
                    return map[cat] || 'bg-gray-400';
                };
                const getTransportIcon = (type) => {
                    const map = { 'walk': 'fa-solid fa-person-walking', 'car': 'fa-solid fa-car', 'train': 'fa-solid fa-train-subway' };
                    return map[type] || 'fa-solid fa-arrow-right';
                };
                const openMap = (keyword) => {
                    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(keyword)}`, '_blank');
                };

                // Info Tab
                const currencyInput = ref('');
                const convertedCurrency = computed(() => {
                    if(!currencyInput.value) return 0;
                    return (parseFloat(currencyInput.value) * 0.22).toFixed(0);
                });
                const flights = [
                    { date: '2026.01.25', depCode: 'TPE', depTime: '02:30', arrCode: 'KIX', arrTime: '06:00', number: 'GK50', duration: '2h 30m' },
                    { date: '2026.01.25', depCode: 'KIX', depTime: '08:00', arrCode: 'NRT', arrTime: '09:25', number: 'GK230', duration: '1h 25m' },
                    { date: '2026.02.01', depCode: 'NRT', depTime: '08:30', arrCode: 'TPE', arrTime: '11:50', number: 'GK13', duration: '4h 20m' },
                ];
                const hotels = [
                    { name: 'Daiwa Roynet Hotel Nagoya', address: '1-23-20 Meieki-minami, Nagoya', period: 'Day 1 - 3' },
                    { name: 'Keisei Richmond Hotel Tokyo Oshiage', address: '1-8-23 Oshiage, Sumida, Tokyo', period: 'Day 4 - 6' },
                    { name: 'Richmond Hotel Narita', address: '970 Hanasaki-chou, Narita', period: 'Day 7' }
                ];

                // Shopping
                const shoppingList = ref([]);
                const showShoppingModal = ref(false);
                const shoppingForm = reactive({ name: '', image: null });

                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        const reader = new FileReader();
                        reader.onload = (e) => shoppingForm.image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                const addShoppingItem = () => {
                    if(shoppingForm.name) {
                        const newList = [...shoppingList.value, { ...shoppingForm }];
                        shoppingList.value = newList;
                        setDoc(doc(db, TRIP_COLLECTION, 'shopping'), { items: newList });
                        shoppingForm.name = ''; shoppingForm.image = null;
                        showShoppingModal.value = false;
                    }
                };
                const removeShoppingItem = (idx) => {
                    if(confirm('刪除此商品？')) {
                        const newList = [...shoppingList.value];
                        newList.splice(idx, 1);
                        shoppingList.value = newList;
                        setDoc(doc(db, TRIP_COLLECTION, 'shopping'), { items: newList });
                    }
                };

                // Expenses
                const expenses = ref([]);
                const showExpenseModal = ref(false);
                const expenseForm = reactive({ category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', payment: '現金' });
                
                const openExpenseModal = () => {
                    expenseForm.date = itineraryDays.value[selectedDayIndex.value].date;
                    showExpenseModal.value = true;
                };
                const saveExpense = () => {
                    if(expenseForm.name && expenseForm.amount) {
                        const newList = [...expenses.value, { ...expenseForm }];
                        expenses.value = newList;
                        setDoc(doc(db, TRIP_COLLECTION, 'expenses'), { items: newList });
                        expenseForm.name = ''; expenseForm.amount = '';
                        showExpenseModal.value = false;
                    }
                };
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + parseInt(item.amount || 0), 0));
                const expensesByMethod = (method) => {
                    const sum = expenses.value.filter(e => e.payment === method).reduce((s, i) => s + parseInt(i.amount||0), 0);
                    return '¥' + sum.toLocaleString();
                }
                const getExpenseIcon = (cat) => {
                    const map = { '飲食':'fa-utensils', '交通':'fa-train', '住宿':'fa-bed', '購物':'fa-bag-shopping', '門票':'fa-ticket' };
                    return map[cat] || 'fa-circle';
                }

                return {
                    loading, currentTab, tabs, headerImage,
                    itineraryDays, selectedDayIndex, selectedDayData, currentWeather,
                    showModal, isEditing, modalForm, openModal, saveItem, deleteItemConfirm, editItem, dragStart, drop,
                    getCategoryColor, getTransportIcon, openMap,
                    currencyInput, convertedCurrency, flights, hotels,
                    shoppingList, showShoppingModal, shoppingForm, handleImageUpload, addShoppingItem, removeShoppingItem,
                    expenses, showExpenseModal, expenseForm, openExpenseModal, saveExpense, totalExpenses, expensesByMethod, getExpenseIcon
                };
            }
        }).mount('#app');
    </script>
</body>
</html>